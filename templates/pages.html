{% extends 'base.html' %}
{% load static %}

{% block title %}Socialite - Pages{% endblock %}

{% block content %}
<div class="flex max-lg:flex-col 2xl:gap-12 gap-10 2xl:max-w-[1220px] max-w-[1065px] mx-auto" id="js-oversized">

    <div class="flex-1">
        <div class="max-w-[680px] w-full mx-auto">

            <div class="page-heading">
                <h1 class="page-title">Pages</h1>
                <nav class="nav__underline">
                    <ul class="group"
                        uk-switcher="connect: #page-tabs ; animation: uk-animation-slide-right-medium, uk-animation-slide-left-medium">
                        <li><a href="#">Find Your Travel Duo</a></li>
                        <li><a href="#">People You Might Know</a></li>
                        <li><a href="#">People You May Like</a></li>
                    </ul>
                </nav>
            </div>

            <!-- Featured Slider -->
            <div tabindex="-1" uk-slider="finite:true">
                <div class="uk-slider-container pb-1">
                    <ul class="uk-slider-items grid-small">
                        {% for user in travel_duo %}
                        <li class="lg:w-1/4 sm:w-1/3 w-1/2">
                            <div class="card uk-transition-toggle">
                                <a href="{% url 'profile' user.slug %}">
                                    <div class="card-media sm:aspect-[2/1.9] h-40">
                                        <img src="{{ user.profile_image|default:'/static/images/avatars/avatar-default.webp' }}"
                                             alt="{{ user.first_name }} {{ user.last_name }}"
                                             class="object-cover w-full h-full">
                                        <div class="card-overly"></div>
                                    </div>
                                </a>
                                <div class="card-body p-3 w-full z-10 absolute bg-gradient-to-t bottom-0 from-black/60">
                                    <p class="card-text text-xs text-white/80">
                                        Destinations: {% for flag in user.common_future_countries %}{{ flag }} {% endfor %}
                                    </p>
                                    <a href="{% url 'profile' user.slug %}">
                                        <h4 class="card-title text-sm mt-0.5 !text-white">{{ user.first_name }} {{ user.last_name }}</h4>
                                    </a>
                                </div>
                            </div>
                        </li>
                        {% empty %}
                        <li class="lg:w-1/4 sm:w-1/3 w-1/2">
                            <div class="card">
                                <div class="card-body p-3">
                                    <p class="text-gray-500 text-sm">No travel companions found.</p>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <a class="nav-prev" href="#" uk-slider-item="previous">
                    <ion-icon name="chevron-back" class="text-2xl"></ion-icon>
                </a>
                <a class="nav-next" href="#" uk-slider-item="next">
                    <ion-icon name="chevron-forward" class="text-2xl"></ion-icon>
                </a>
            </div>

            <div id="page-tabs" class="uk-switcher mt-10">

                <!-- Tab 1: Find Your Travel Duo -->
                <div class="grid sm:grid-cols-3 grid-cols-2 gap-3"
                     uk-scrollspy="target: > div; cls: uk-animation-scale-up; delay: 100 ;repeat: true">
                    {% for user in travel_duo %}
                    <div class="card">
                        <a href="{% url 'profile' user.slug %}">
                            <div class="card-media sm:aspect-[2/1.7] h-40">
                                <img src="{{ user.profile_image|default:'/static/images/avatars/avatar-default.webp' }}"
                                     alt="{{ user.first_name }} {{ user.last_name }}"
                                     class="object-cover w-full h-full rounded-t-lg">
                                <div class="card-overly"></div>
                            </div>
                        </a>
                        <div class="card-body p-4">
                            <a href="{% url 'profile' user.slug %}">
                                <h4 class="card-title text-base font-semibold">{{ user.first_name }} {{ user.last_name }}</h4>
                            </a>
                            <p class="card-text text-sm text-gray-500">{{ user.follower_count }} Followers</p>
                            <p class="card-text text-sm text-gray-600">
                                Destinations: {% for flag in user.common_future_countries %}{{ flag }} {% endfor %}
                            </p>
                            <button type="button"
                                    class="button bg-primary text-white follow-btn mt-2 w-full"
                                    data-user-id="{{ user.user_id }}"
                                    data-is-following="{{ user.is_following|yesno:'true,false' }}">
                                {{ user.is_following|yesno:'Unfollow,Follow' }}
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-span-3 text-center py-6">
                        <p class="text-gray-500">No travel companions found at the moment.</p>
                    </div>
                    {% endfor %}
                    <div class="flex justify-center my-6 lg:col-span-3 col-span-2">
                        <button type="button"
                                class="bg-white py-2 px-5 rounded-full shadow-md font-semibold text-sm dark:bg-dark2">
                            Load more...
                        </button>
                    </div>
                </div>

                <!-- Tab 2: People You Might Know -->
                <div class="grid sm:grid-cols-2 gap-3"
                     uk-scrollspy="target: > div; cls: uk-animation-scale-up; delay: 100 ;repeat: true">
                    {% for user in might_know %}
                    <div class="card flex space-x-5 p-5">
                        <a href="{% url 'profile' user.slug %}">
                            <div class="card-media w-16 h-16 shrink-0 rounded-full">
                                <img src="{{ user.profile_image|default:'/static/images/avatars/avatar-default.webp' }}"
                                     alt="{{ user.first_name }} {{ user.last_name }}"
                                     class="object-cover w-full h-full">
                                <div class="card-overly"></div>
                            </div>
                        </a>
                        <div class="card-body flex-1 p-0">
                            <a href="{% url 'profile' user.slug %}">
                                <h4 class="card-title">{{ user.first_name }} {{ user.last_name }}</h4>
                            </a>
                            <p class="card-text">{{ user.follower_count }} Followers</p>
                            <p class="card-text text-sm text-gray-600">
                                {% if user.common_visited_countries %}
                                    Visited Countries: {% for flag in user.common_visited_countries %}{{ flag }} {% endfor %}
                                {% endif %}
                                {% if user.nationality_match %}
                                    {% if user.common_visited_countries %}<br>{% endif %}
                                    Same Nationality
                                {% endif %}
                            </p>
                            <button type="button"
                                    class="button bg-primary-soft text-primary dark:text-white follow-btn mt-1"
                                    data-user-id="{{ user.user_id }}"
                                    data-is-following="{{ user.is_following|yesno:'true,false' }}">
                                {{ user.is_following|yesno:'Unfollow,Follow' }}
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-span-2 text-center py-6">
                        <p class="text-gray-500">No people you might know at the moment.</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Tab 3: People You May Like -->
                <div class="grid sm:grid-cols-2 gap-3"
                     uk-scrollspy="target: > div; cls: uk-animation-scale-up; delay: 100 ;repeat: true">
                    {% for user in may_like %}
                    <div class="card flex space-x-5 p-5">
                        <a href="{% url 'profile' user.slug %}">
                            <div class="card-media w-16 h-16 shrink-0 rounded-full">
                                <img src="{{ user.profile_image|default:'/static/images/avatars/avatar-default.webp' }}"
                                     alt="{{ user.first_name }} {{ user.last_name }}"
                                     class="object-cover w-full h-full">
                                <div class="card-overly"></div>
                            </div>
                        </a>
                        <div class="card-body flex-1 p-0">
                            <a href="{% url 'profile' user.slug %}">
                                <h4 class="card-title">{{ user.first_name }} {{ user.last_name }}</h4>
                            </a>
                            <p class="card-text">{{ user.follower_count }} Followers</p>
                            <p class="card-text text-sm text-gray-600">
                                Compatibility Score: {{ user.score }}
                            </p>
                            <button type="button"
                                    class="button bg-primary-soft text-primary dark:text-white follow-btn mt-1"
                                    data-user-id="{{ user.user_id }}"
                                    data-is-following="{{ user.is_following|yesno:'true,false' }}">
                                {{ user.is_following|yesno:'Unfollow,Follow' }}
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-span-2 text-center py-6">
                        <p class="text-gray-500">No suggestions at the moment.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="lg:w-[380px]">
        <div class="lg:space-y-6 space-y-4 lg:pb-8 max-lg:grid sm:grid-cols-2 gap-6">
            <!-- Search -->
            <div>
                <div class="relative">
                    <div class="flex absolute inset-y-0 left-0 items-center pl-3.5 pointer-events-none">
                        <ion-icon name="search" class="text-2xl text-gray-400"></ion-icon>
                    </div>
                    <input type="text"
                           class="bg-gray-100 dark:bg-dark2 rounded-full w-full pl-12 !py-2 !font-normal !text-base placeholder-gray-400 dark:placeholder-gray-300"
                           placeholder="Search Pages">
                </div>
            </div>

            <!-- Pages You Manage -->
            <div>
                <div class="card p-5">
                    <h4 class="text-base font-semibold mb-3">Pages You Manage</h4>
                    <div class="space-y-4">
                        {% for user in might_know|slice:":2" %}
                        <div class="flex items-center gap-3">
                            <a href="{% url 'profile' user.slug %}">
                                <img src="{{ user.profile_image|default:'/static/images/avatars/avatar-default.webp' }}"
                                     alt="{{ user.first_name }} {{ user.last_name }}"
                                     class="w-10 h-10 rounded-full object-cover">
                            </a>
                            <div>
                                <a href="{% url 'profile' user.slug %}">
                                    <h4 class="font-semibold text-sm">{{ user.first_name }} {{ user.last_name }}</h4>
                                </a>
                                <div class="text-xs text-gray-500 mt-0.5">{{ user.follower_count }} Followers</div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-sm">No managed pages at the moment.</p>
                        {% endfor %}
                    </div>
                    <div class="flex justify-center mt-4">
                        <button type="button"
                                class="bg-gray-100 dark:bg-dark2 py-2 px-5 rounded-full font-semibold text-sm">
                            See All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Discover -->
            <div>
                <div class="card p-5">
                    <h4 class="text-base font-semibold mb-3">Discover</h4>
                    <div class="space-y-4">
                        {% for user in may_like|slice:":2" %}
                        <div class="flex items-center gap-3">
                            <a href="{% url 'profile' user.slug %}">
                                <img src="{{ user.profile_image|default:'/static/images/avatars/avatar-default.webp' }}"
                                     alt="{{ user.first_name }} {{ user.last_name }}"
                                     class="w-10 h-10 rounded-full object-cover">
                            </a>
                            <div>
                                <a href="{% url 'profile' user.slug %}">
                                    <h4 class="font-semibold text-sm">{{ user.first_name }} {{ user.last_name }}</h4>
                                </a>
                                <div class="text-xs text-gray-500 mt-0.5">{{ user.follower_count }} Followers</div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-sm">No suggestions at the moment.</p>
                        {% endfor %}
                    </div>
                    <div class="flex justify-center mt-4">
                        <button type="button"
                                class="bg-gray-100 dark:bg-dark2 py-2 px-5 rounded-full font-semibold text-sm">
                            See All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Follow/Unfollow -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const followButtons = document.querySelectorAll('.follow-btn');
    const token = localStorage.getItem('token');

    if (!token) {
        console.error('No token found in localStorage');
        alert('Please log in again to follow/unfollow a user.');
        return;
    }

    followButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const isFollowing = this.getAttribute('data-is-following') === 'true';

            fetch('/follow-unfollow/', {  // Updated endpoint to match previous version
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Authorization': `Bearer ${token}`
                },
                body: `target_user_id=${userId}`
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Unauthorized: Invalid or expired token');
                    }
                    throw new Error(`Network error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (data.action === 'followed') {
                        this.textContent = 'Unfollow';
                        this.setAttribute('data-is-following', 'true');
                        this.classList.remove('bg-primary', 'text-white');
                        this.classList.add('bg-gray-200', 'text-gray-700');
                    } else {
                        this.textContent = 'Follow';
                        this.setAttribute('data-is-following', 'false');
                        this.classList.remove('bg-gray-200', 'text-gray-700');
                        this.classList.add('bg-primary', 'text-white');
                    }
                } else {
                    alert(data.message || 'An error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message || 'An error occurred while processing your request');
            });
        });
    });
});
</script>
{% endblock %}